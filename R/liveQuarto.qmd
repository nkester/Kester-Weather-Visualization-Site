---
title: "Kester Weather Station"
subtitle: "Pulling Live Data"
author: "Grant and Neil Kester"
date: "20 February 2024"
theme: 
  - flatly
execute: 
  echo: true
format: 
  html:
    code-fold: true
    code-summary: "Show the code"
    embed-resources: false
    echo: true
    code-tools: 
      source: https://github.com/nkester/Kester-Weather-Visualization-Site
    page-layout: full
    output-file: "live"
    output-ext: "html"
---

version: 0.1.2 : Add support for multiple endpoints.

In this version of the web-page, we are pulling live data from our Google Cloud Functions.


# Charting

Currently this data is set to the last seven days of measurements. In the future, we will allow users to select which time scale and aggregation they desire.

```{ojs inputs}
//| echo: false
//| panel: sidebar

viewof measure_scale = Inputs.select([
"Select One",
"Seven days, no aggregation",
"Fourteen days, no aggregation"
],
{label: "Select a time scale"})

viewof measure_type = Inputs.select([
"Air Temperature",
"Air Humidity",
"Barometric Pressure",
"Light Intensity",
"Rain Gauge",
"UV Index",
"Wind Direction Sensor",
"Wind Speed"], 
{label: "Select a measure"})

```

:::{.panel-tabset}  

## Plot

```{ojs}
Plot.dot(filteredData,
  {
    x: "local_time",
    y: "measurementValue", 
    stroke: "measurementValue",
    tip: true
  })
  .plot()
```


The plot as a line graph.


```{ojs}
Plot.plot({
  marks: [
    Plot.line(filteredData, 
      {
        x: "local_time",
        y: "measurementValue"
      })
    ]
})
```

## OJS Table

Filtered Data Table  

```{ojs}
Inputs.table(filteredData)
```  

:::



## Appendix

Find the source code on GitHub at [Kester Weather Visualization Site](https://github.com/nkester/Kester-Weather-Visualization-Site)


```{ojs imports}

import { aq, op } from '@uwdata/arquero'
d3 = require("d3@7")
parser = d3.timeParse("%Y-%m-%d %H:%M:%S");
```

```{ojs filterData}

// Arquero is an ojs package for data manipulation similar to dplyr. I import it
//  above as well in the `imports` chunk. I use arquero (`aq`) to convert the 
//  data returned by the cloud function from a string to a datetime object.
//  I've defined the date parser with `D3`, another `ojs` package. An example
//  of that is here: https://stackoverflow.com/questions/76499928/passing-dates-from-r-chunk-to-ojs-chunk-using-ojs-define-in-quarto  
//  
// https://quarto.org/docs/interactive/ojs/examples/arquero.html
 measures = {
  if (measure_scale === "Seven days, no aggregation"){
    return(await d3.json("https://us-east1-weather-station-ef6ca.cloudfunctions.net/https_measure_7day_asis"))
  }
  else if (measure_scale === "Fourteen days, no aggregation"){
    return(await d3.json("https://us-east1-weather-station-ef6ca.cloudfunctions.net/https_measure_14day_asis"))
  }
  else{
    return(JSON.parse('[{"local_time":"1000-02-02 11:11:11","type": "test","measurementValue":"49"}]'))
  }
}
 

filteredData = aq.from(measures)
.derive({ local_time: aq.escape(d => parser(d.local_time)) })
.params({
    m: measure_type
  })
  .filter((d,p) => aq.op.includes(d.type, p.m))

```

```{ojs}
measures
```

[Personal Website](https://www.about.nkester.com)